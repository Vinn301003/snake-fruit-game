<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bubble Shooter</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    canvas {
      border: 2px solid white;
      touch-action: none;
    }
  </style>
</head>
<body>
<canvas id="game" width="480" height="640"></canvas>

<script>
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  const ROWS = 10;
  const COLS = 8;
  const RADIUS = 24;
  const COLORS = ['red', 'blue', 'green', 'yellow', 'purple'];
  const SPEED = 6;

  let grid = [];
  let score = 0;
  let highScore = localStorage.getItem('bubbleHighScore') || 0;

  let shooter = {
    x: canvas.width / 2,
    y: canvas.height - RADIUS - 10,
    angle: -Math.PI / 2,
    color: randomColor(),
    shooting: false,
    shotX: 0,
    shotY: 0,
    dx: 0,
    dy: 0
  };

  const bgImage = new Image();
  bgImage.src = 'foto.png';

  bgImage.onload = () => {
    initGrid();
    requestAnimationFrame(gameLoop);
  };

  function randomColor() {
    return COLORS[Math.floor(Math.random() * COLORS.length)];
  }

  function initGrid() {
    for (let row = 0; row < ROWS; row++) {
      grid[row] = [];
      for (let col = 0; col < COLS; col++) {
        if (row < 5) {
          grid[row][col] = { color: randomColor() };
        } else {
          grid[row][col] = null;
        }
      }
    }
  }

  function drawBubble(x, y, color) {
    ctx.beginPath();
    ctx.arc(x, y, RADIUS - 2, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.stroke();
  }

  function drawGrid() {
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLS; col++) {
        const bubble = grid[row][col];
        if (bubble) {
          const x = col * RADIUS * 2 + RADIUS;
          const y = row * RADIUS * 2 + RADIUS;
          drawBubble(x, y, bubble.color);
        }
      }
    }
  }

  function drawShooter() {
    drawBubble(shooter.x, shooter.y, shooter.color);
    drawArrow();
  }

  function drawArrow() {
    const len = 50;
    const endX = shooter.x + Math.cos(shooter.angle) * len;
    const endY = shooter.y + Math.sin(shooter.angle) * len;

    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(shooter.x, shooter.y);
    ctx.lineTo(endX, endY);
    ctx.stroke();
  }

  function shootBubble() {
    if (!shooter.shooting) {
      shooter.shotX = shooter.x;
      shooter.shotY = shooter.y;
      shooter.dx = Math.cos(shooter.angle) * SPEED;
      shooter.dy = Math.sin(shooter.angle) * SPEED;
      shooter.shooting = true;
    }
  }

  function updateShot() {
    if (shooter.shooting) {
      shooter.shotX += shooter.dx;
      shooter.shotY += shooter.dy;

      // Bounce from side walls
      if (shooter.shotX <= RADIUS || shooter.shotX >= canvas.width - RADIUS) {
        shooter.dx *= -1;
      }

      // Collision with top
      if (shooter.shotY <= RADIUS) {
        placeInGrid(shooter.shotX, shooter.shotY, shooter.color);
        shooter.shooting = false;
        shooter.color = randomColor();
        return;
      }

      // Collision with bubbles
      for (let row = 0; row < ROWS; row++) {
        for (let col = 0; col < COLS; col++) {
          const bubble = grid[row][col];
          if (bubble) {
            const x = col * RADIUS * 2 + RADIUS;
            const y = row * RADIUS * 2 + RADIUS;
            const dist = Math.hypot(x - shooter.shotX, y - shooter.shotY);
            if (dist < RADIUS * 2 - 2) {
              placeInGrid(shooter.shotX, shooter.shotY, shooter.color);
              shooter.shooting = false;
              shooter.color = randomColor();
              return;
            }
          }
        }
      }

      drawBubble(shooter.shotX, shooter.shotY, shooter.color);
    }
  }

  function placeInGrid(x, y, color) {
    const col = Math.floor(x / (RADIUS * 2));
    const row = Math.floor(y / (RADIUS * 2));
    if (row >= 0 && row < ROWS && col >= 0 && col < COLS) {
      if (!grid[row][col]) {
        grid[row][col] = { color };
        score += 10;
        if (score > highScore) {
          highScore = score;
          localStorage.setItem('bubbleHighScore', highScore);
        }
      }
    }
  }

  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    shooter.angle = Math.atan2(my - shooter.y, mx - shooter.x);
  });

  canvas.addEventListener('click', shootBubble);

  function drawScore() {
    ctx.fillStyle = 'white';
    ctx.font = '20px Arial';
    ctx.fillText(`Skor: ${score}`, 10, 20);
    ctx.fillText(`Skor Tertinggi: ${highScore}`, 10, 45);
  }

  function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    drawGrid();
    updateShot();
    drawShooter();
    drawScore();
    requestAnimationFrame(gameLoop);
  }
</script>
</body>
</html>
